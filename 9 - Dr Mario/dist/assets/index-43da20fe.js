var f=Object.defineProperty;var p=(c,e,t)=>e in c?f(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t;var a=(c,e,t)=>(p(c,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(o){if(o.ep)return;o.ep=!0;const i=t(o);fetch(o.href,i)}})();class r{constructor(e=0,t=0){a(this,"x");a(this,"y");this.x=e,this.y=t}static down(){return new r(0,1)}static right(){return new r(1,0)}static left(){return new r(-1,0)}static addVec(e,t){return new r(e.x+t.x,e.y+t.y)}add(e,t){this.x+=e,this.y+=t}addVec(e){this.x+=e.x,this.y+=e.y}subtract(e,t){this.x-=e,this.y-=t}subtractVec(e){this.x-=e.x,this.y-=e.y}outOfBoard(e){return this.x<0||this.x>=e}}var h=(c=>(c[c.DEG0=0]="DEG0",c[c.DEG90=1]="DEG90",c[c.DEG180=2]="DEG180",c[c.DEG270=3]="DEG270",c))(h||{});class m{constructor(e,t,s,o,i,n=0){a(this,"timeout",0);a(this,"frequency",5);a(this,"frame",0);a(this,"framesInTotal");a(this,"size");a(this,"div",document.createElement("div"));a(this,"offset");a(this,"nextFrameOffset");a(this,"positions");a(this,"positionsIndex",0);a(this,"positionTimeout",0);a(this,"positionChangeFrequency",3*this.frequency);this.size=t,this.positions=i,this.offset=s,this.nextFrameOffset=n,this.framesInTotal=o,this.div.classList.add("spritesheet"),this.div.style.width=`${t.x}px`,this.div.style.height=`${t.y}px`,this.div.style.backgroundPositionX=`${-s}px`,this.div.style.position="absolute",this.div.style.left=`${i[0].x}px`,this.div.style.top=`${i[0].y}px`,e.appendChild(this.div)}update(){if(this.timeout=(this.timeout+1)%this.frequency,this.timeout===0){++this.frame>=this.framesInTotal&&(this.frame=0);const e=this.offset+(this.size.x+this.nextFrameOffset)*this.frame;this.div.style.backgroundPositionX=`${-e}px`}this.positionTimeout=(this.positionTimeout+1)%this.positionChangeFrequency,this.positionTimeout===0&&(this.positionsIndex=(this.positionsIndex+1)%this.positions.length,this.div.style.left=`${this.positions[this.positionsIndex].x}px`,this.div.style.top=`${this.positions[this.positionsIndex].y}px`)}}a(m,"imgSrc","/spritesheet.png");const l=class{constructor(){a(this,"board");a(this,"boardHTML");a(this,"blocks",new Map);a(this,"elementInControl",{id:-1,segments:[],angle:h.DEG0,active:!1});a(this,"loop",-1);a(this,"nextId",1);a(this,"scoreCounter",0);a(this,"recordCounter",0);a(this,"viruses",new Map);a(this,"virusCount",4);a(this,"colors",["red","blue","green"]);a(this,"staticAnimations");a(this,"frame",0);a(this,"buttonDown",!1);a(this,"state",0);a(this,"toDelete",new Map);a(this,"hand");a(this,"nextBlock");console.log("Game start"),this.createScoreCounter();const[e,t]=this.createBoard(l.boardWidth,l.boardHeight);this.board=e,this.boardHTML=t,l.mainDiv.append(this.boardHTML),l.mainDiv.classList.add("mainDiv","spritesheet"),document.body.append(l.mainDiv),this.staticAnimations=this.createStaticAnimations(),this.hand=this.createPillHand(),this.hand.forEach(s=>l.mainDiv.append(s)),this.nextBlock=this.generateNewBlock(),this.createVirusCounter(),this.handleKeys()}handleKeys(){document.addEventListener("keydown",e=>{switch(e.code){case"KeyD":if(this.buttonDown||this.state!==0)break;this.canMove(this.elementInControl,r.right())&&this.move(this.elementInControl,r.right());break;case"KeyA":if(this.buttonDown||this.state!==0)break;this.canMove(this.elementInControl,r.left())&&this.move(this.elementInControl,r.left());break;case"KeyS":this.buttonDown=!0;break;case"KeyW":if(this.buttonDown||this.state!==0)break;this.rotate(this.elementInControl);break;case"KeyE":if(this.buttonDown||this.state!==0)break;this.rotate(this.elementInControl,!0);break;case"KeyP":clearInterval(this.loop);break}})}createRow(e,t){const s=new Array(e),o=document.createElement("tr");for(let i=0;i<e;i++){s[i]=0;const n=document.createElement("td");n.classList.add("cell"),n.id=`${i}_${t}`,o.append(n)}return[s,o]}createBoard(e,t){const s=new Array(t),o=document.createElement("table");for(let i=0;i<t;i++){const[n,d]=this.createRow(e,i);s[i]=n,o.append(d)}return[s,o]}createPillHand(){return[document.createElement("div"),document.createElement("div"),document.createElement("div")]}createScoreCounter(){const e=document.createElement("div");this.recordCounter=parseInt(window.localStorage.getItem("record")??"0"),this.scoreCounter=0;const t=document.createElement("div");t.id="recordImgs";const s=document.createElement("div");s.id="scoreImgs",this.updateScoreDiv(t,this.recordCounter),this.updateScoreDiv(s,this.scoreCounter),e.append(t),e.append(s),l.mainDiv.append(e)}addZerosToScore(e,t=7){return(Array(t-e.length).fill(0).join("")??"")+e}convertToImages(e){const t=[];for(let s=0;s<e.length;s++){const o=document.createElement("div");o.style.backgroundPositionX=`${-1155-parseInt(e[s])*24}px`,o.classList.add("spritesheet","letter"),t.push(o)}return t}updateScoreDiv(e,t){e.innerHTML="",this.convertToImages(this.addZerosToScore(t.toString())).forEach(s=>{e.append(s)})}createVirusCounter(){const e=document.createElement("div");e.id="virusCounter",this.convertToImages(this.addZerosToScore(this.virusCount.toString(),2)).forEach(t=>e.append(t)),l.mainDiv.append(e)}updateVirusCounter(){this.virusCount--;const e=document.getElementById("virusCounter");e!==null&&(e.innerHTML="",this.convertToImages(this.addZerosToScore(this.virusCount.toString(),2)).forEach(t=>e.append(t))),this.virusCount===0&&this.stageComplete()}createStaticAnimations(){return[{size:new r(96,73),offset:0,framesInTotal:2,nextFrameOffset:96,positions:[new r(30,220),new r(70,295),new r(120,230)]},{size:new r(96,73),offset:384,framesInTotal:2,nextFrameOffset:96,positions:[new r(120,230),new r(30,220),new r(70,295)]},{size:new r(96,73),offset:768,framesInTotal:2,nextFrameOffset:96,positions:[new r(70,295),new r(120,230),new r(30,220)]}].map(t=>new m(l.mainDiv,t.size,t.offset,t.framesInTotal,t.positions,t.nextFrameOffset))}randomColor(){const e=Math.round(Math.random()*1e3)%3;return e>=0&&e<this.colors.length?this.colors[e]:"violet"}generateNewBlock(){const e=[{position:new r(Math.floor(l.boardWidth/2)-1,0),color:this.randomColor(),frame:0,frequency:5,numOfFrames:4},{position:new r(Math.floor(l.boardWidth/2),0),color:this.randomColor(),frame:0,frequency:5,numOfFrames:4}];for(let t=0;t<e.length;t++)this.hand[t].className="cell",this.hand[t].classList.add("spritesheet"),this.hand[t].classList.add(`pill-hand-${t+1}`),this.hand[t].classList.add(`${e[t].color}-`);return this.hand[2].className="hand",{id:this.nextId,segments:e,angle:h.DEG0,active:!0}}spawnNewBlock(){this.buttonDown=!1,this.elementInControl=this.nextBlock;for(const e of this.elementInControl.segments)if(this.isCellOccupied(e.position,0)){this.gameOver();return}this.blocks.set(this.nextId++,this.elementInControl);for(let e=0;e<this.elementInControl.segments.length;e++)this.hand[e].classList.add(`pill-animation-${e+1}`);this.hand[2].classList.add("hand-animation"),this.state=2,setTimeout(()=>{this.state=0;for(let e=0;e<this.elementInControl.segments.length;e++)this.updateBoard(0,this.elementInControl.id,this.elementInControl.segments[e].position.x,this.elementInControl.segments[e].position.y,this.elementInControl.segments[e].color),this.nextBlock=this.generateNewBlock()},1800)}isCellOccupied(e,t){return this.board[e.y][e.x]!==0&&this.board[e.y][e.x]!==t}canMove(e,t){for(const s of e.segments){const o=r.addVec(s.position,t);if(o.y>=l.boardHeight||o.x<0||o.x>=l.boardWidth||this.isCellOccupied(o,e.id))return!1}return!0}move(e,t){for(let s=0;s<e.segments.length;s++)this.updateBoard(1,e.id,e.segments[s].position.x,e.segments[s].position.y,e.segments[s].color);for(let s=0;s<e.segments.length;s++)e.segments[s].position.addVec(t),this.updateBoard(0,e.id,e.segments[s].position.x,e.segments[s].position.y,e.segments[s].color)}canRotate(e){let t=!0;for(let s=0;s<e.segments.length;s++)if(e.segments[s].position.outOfBoard(l.boardWidth)||this.isCellOccupied(e.segments[s].position,e.id)){t=!1;break}if(!t){const s=r.left();if(this.canMove(e,s)){for(let o=0;o<e.segments.length;o++)e.segments[o].position.addVec(s);return!0}else return!1}return!0}rotateVector(e,t=!1){switch(e){case h.DEG0:return t?[new r,new r(-1,-1)]:[new r(0,-1),new r(-1,0)];case h.DEG90:return t?[new r(0,1),new r(1,0)]:[new r(1,1),new r];case h.DEG180:return t?[new r(-1,-1),new r]:[new r(-1,0),new r(0,-1)];case h.DEG270:return t?[new r(1,0),new r(0,1)]:[new r,new r(1,1)];default:console.error("Incorrect angle: ",e)}return[new r,new r]}nextAngle(e,t){return t?e===h.DEG0?h.DEG270:e-1:e===h.DEG270?h.DEG0:e+1}rotate(e,t=!1){for(let i=0;i<e.segments.length;i++)this.updateBoard(1,e.id,e.segments[i].position.x,e.segments[i].position.y,e.segments[i].color);const s=this.rotateVector(e.angle,t),o=e.angle;if(e.segments[0].position.y!==0){e.angle=this.nextAngle(e.angle,t);for(let i=0;i<e.segments.length;i++)e.segments[i].position.addVec(s[i]);if(!this.canRotate(e)){e.angle=o;for(let i=0;i<e.segments.length;i++)e.segments[i].position.subtractVec(s[i])}}for(let i=0;i<e.segments.length;i++)this.updateBoard(0,e.id,e.segments[i].position.x,e.segments[i].position.y,e.segments[i].color)}updateBoard(e,t,s,o,i="",n=""){switch(e){case 0:this.board[o][s]=t,this.boardHTML.rows[o].cells[s].classList.add("spritesheet"),t>0?this.boardHTML.rows[o].cells[s].classList.add(`${i}-${n}`):this.boardHTML.rows[o].cells[s].classList.add(`virus-${i}`);break;case 1:this.board[o][s]=0,this.boardHTML.rows[o].cells[s].className="cell";break;case 2:this.boardHTML.rows[o].cells[s].className="cell",t>0?(this.boardHTML.rows[o].cells[s].classList.add("spritesheet"),this.boardHTML.rows[o].cells[s].classList.add(`${i}-${n}`)):this.boardHTML.rows[o].cells[s].classList.add(`virus-${i}`);break;default:console.error("Unknown update operation:",e)}}eliminateToSmall(e){for(let t=0;t<e.length;t++)e[t].length<4&&(e[t].length=0)}resetForNextCheck(e,t){return e[t].length>=4?(e.push([]),t++):e[t].length=0,t}checkRow(e){const t=[];t.push([]);let s=0;for(let o=0;o<l.boardWidth;o++)if(this.board[e][o]>0){const i=this.blocks.get(this.board[e][o]);if(typeof i>"u")continue;const n=i.segments[0].position.x===o&&i.segments[0].position.y===e?0:1;t[s].length>0&&t[s][0][0].color!==i.segments[n].color&&(s=this.resetForNextCheck(t,s)),t[s].push([i.segments[n],i.id])}else s=this.resetForNextCheck(t,s);return this.eliminateToSmall(t),t}checkColumn(e){const t=[];t.push([]);let s=0;for(let o=0;o<l.boardHeight;o++){const i=this.board[o][e];if(i>0){const n=this.blocks.get(i);if(typeof n>"u")continue;const d=n.segments[0].position.x===e&&n.segments[0].position.y===o?0:1;t[s].length>0&&t[s][0][0].color!==n.segments[d].color&&(s=this.resetForNextCheck(t,s)),t[s].push([n.segments[d],n.id])}else if(i<0){const n=this.viruses.get(i);if(typeof n>"u")continue;t[s].length>0&&t[s][0][0].color!==n.color&&(s=this.resetForNextCheck(t,s)),t[s].push([n,i])}else s=this.resetForNextCheck(t,s)}return this.eliminateToSmall(t),t}tryToDestroy(e){const t=new Map;for(const s of e.segments){for(const o of this.checkRow(s.position.y))for(const[i,n]of o)t.set(i,n);for(const o of this.checkColumn(s.position.x))for(const[i,n]of o)t.set(i,n)}return this.toDelete=t,t.size>3}destroy(){const e=[];this.toDelete.forEach((t,s)=>{const o=this.blocks.get(t);if(typeof o<"u"){const i=o.segments[0].position.x===s.position.x&&o.segments[0].position.y===s.position.y?0:1,n=o.segments[i];if(n.frame<n.numOfFrames*n.frequency){const d=`explosion-${Math.floor(n.frame/(n.numOfFrames*n.frequency))}`;this.updateBoard(2,o.id,n.position.x,n.position.y,n.color,d),n.frame++}else this.updateBoard(1,o.id,n.position.x,n.position.y,n.color),o.segments.splice(i,1),e.push(s)}else{const i=this.viruses.get(t);typeof i<"u"&&(i.frame<i.numOfFrames*i.frequency?i.frame++:(this.updateBoard(1,t,i.position.x,i.position.y),this.setScore(100),this.viruses.delete(t),e.push(s)))}}),e.forEach(t=>{this.toDelete.get(t)===this.elementInControl.id&&this.spawnNewBlock(),this.toDelete.delete(t)})}setScore(e){this.scoreCounter+=e;const t=document.getElementById("scoreImgs");if(this.updateScoreDiv(t,this.scoreCounter),this.updateVirusCounter(),this.recordCounter<this.scoreCounter){const s=document.getElementById("recordImgs");s!==null&&(this.recordCounter=this.scoreCounter,this.updateScoreDiv(s,this.recordCounter)),window.localStorage.setItem("record",this.recordCounter.toString())}}findFreeSpace(){const e=Math.floor(Math.random()*(l.boardHeight-8))+5,t=Math.floor(Math.random()*(l.boardWidth-1));for(let s=e;s>=0;s--)for(let o=t;o>=0;o--)if(this.board[s][o]===0){let i=!0;for(let n=-1;n<2&&i;n++)for(let d=-1;d<2&&i;d++)s+n<0||s+n>=l.boardHeight||o+d<0||o+d>=l.boardWidth||this.board[s+n][o+d]!==0&&(i=!1);if(i)return[o,s]}return[-1,-1]}spawnVirus(e,t,s,o){const i=(s+1)*-1,n={position:new r(e,t),color:o,frame:0,frequency:5,numOfFrames:4};this.updateBoard(0,i,e,t,o),this.viruses.set(i,n)}generateViruses(){console.log(this.virusCount);for(let e=0;e<this.virusCount;e++){const[t,s]=this.findFreeSpace(),o=this.randomColor();t>-1&&s>-1&&this.spawnVirus(t,s,e,o)}}stageComplete(){console.log("stage complete"),clearInterval(this.loop);const e=document.createElement("dialog");e.classList.add("spritesheet"),e.classList.add("dialog"),e.classList.add("stage-complete"),l.mainDiv.appendChild(e),e.open=!0}gameOver(){console.log("game over"),clearInterval(this.loop);const e=document.createElement("dialog");e.classList.add("spritesheet"),e.classList.add("dialog"),e.classList.add("game-over"),l.mainDiv.appendChild(e),e.open=!0}debugPrintBoard(){for(let e=0;e<l.boardHeight;e++){let t="";for(let s=0;s<l.boardWidth;s++)t+="|"+this.board[e][s].toString();console.log(t)}}mainLoop(){this.loop!==-1&&clearInterval(this.loop),this.elementInControl.id===-1&&this.spawnNewBlock(),this.generateViruses(),this.loop=setInterval(()=>{let e=!1;this.staticAnimations.forEach(s=>s.update());const t=this.blocks.keys();for(const s of t){const o=this.blocks.get(s);if(!(typeof o>"u")){if(o.segments.length===0){this.blocks.delete(s);continue}switch(this.state){case 0:if(o.active)if(this.canMove(o,r.down()))o.id!==this.elementInControl.id||this.frame===0?this.move(o,r.down()):o.id===this.elementInControl.id&&this.buttonDown&&this.move(this.elementInControl,r.down());else if(this.tryToDestroy(o)){this.state=1;for(const[i,n]of this.blocks)n.active=!0}else o.active=!1,o.id===this.elementInControl.id&&!e&&(this.spawnNewBlock(),e=!0);else o.id===this.elementInControl.id&&!e&&(this.spawnNewBlock(),e=!0);break;case 1:this.destroy(),this.toDelete.size===0&&(this.state=0);break}}}this.frame=(this.frame+1)%5},100)}};let u=l;a(u,"mainDiv",document.createElement("div")),a(u,"boardWidth",8),a(u,"boardHeight",16);const g=new u;g.mainLoop();
