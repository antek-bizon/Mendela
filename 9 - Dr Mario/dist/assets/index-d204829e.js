var f=Object.defineProperty;var p=(d,e,t)=>e in d?f(d,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[e]=t;var r=(d,e,t)=>(p(d,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(o){if(o.ep)return;o.ep=!0;const i=t(o);fetch(o.href,i)}})();class a{constructor(e,t){r(this,"x");r(this,"y");this.x=e,this.y=t}static down(){return new a(0,1)}static right(){return new a(1,0)}static left(){return new a(-1,0)}static addVec(e,t){return new a(e.x+t.x,e.y+t.y)}add(e,t){this.x+=e,this.y+=t}addVec(e){this.x+=e.x,this.y+=e.y}subtract(e,t){this.x-=e,this.y-=t}outOfBoard(e){return this.x<0||this.x>=e}}var h=(d=>(d[d.DEG0=0]="DEG0",d[d.DEG90=1]="DEG90",d[d.DEG180=2]="DEG180",d[d.DEG270=3]="DEG270",d))(h||{});class m{constructor(e,t,s,o,i,n=0){r(this,"timeout",0);r(this,"frequency",5);r(this,"frame",0);r(this,"framesInTotal");r(this,"size");r(this,"div",document.createElement("div"));r(this,"offset");r(this,"nextFrameOffset");r(this,"positions");r(this,"positionsIndex",0);r(this,"positionTimeout",0);r(this,"positionChangeFrequency",3*this.frequency);this.size=t,this.positions=i,this.offset=s,this.nextFrameOffset=n,this.framesInTotal=o,this.div.classList.add("spritesheet"),this.div.style.width=`${t.x}px`,this.div.style.height=`${t.y}px`,this.div.style.backgroundPositionX=`${-s}px`,this.div.style.position="absolute",this.div.style.left=`${i[0].x}px`,this.div.style.top=`${i[0].y}px`,e.appendChild(this.div)}update(){if(this.timeout=(this.timeout+1)%this.frequency,this.timeout===0){++this.frame>=this.framesInTotal&&(this.frame=0);const e=this.offset+(this.size.x+this.nextFrameOffset)*this.frame;this.div.style.backgroundPositionX=`${-e}px`}this.positionTimeout=(this.positionTimeout+1)%this.positionChangeFrequency,this.positionTimeout===0&&(this.positionsIndex=(this.positionsIndex+1)%this.positions.length,this.div.style.left=`${this.positions[this.positionsIndex].x}px`,this.div.style.top=`${this.positions[this.positionsIndex].y}px`)}}r(m,"imgSrc","/spritesheet.png");const c=class{constructor(){r(this,"board");r(this,"boardHTML");r(this,"blocks",new Map);r(this,"elementInControl",{id:-1,segments:[],angle:h.DEG0,active:!1});r(this,"loop",-1);r(this,"nextId",1);r(this,"scoreCounter",0);r(this,"recordCounter",0);r(this,"viruses",new Map);r(this,"virusCount",4);r(this,"colors",["red","blue","green"]);r(this,"staticAnimations");r(this,"frame",0);console.log("Game start"),this.createScoreCounter();const[e,t]=this.createBoard(c.boardWidth,c.boardHeight);this.board=e,this.boardHTML=t,c.mainDiv.append(this.boardHTML),c.mainDiv.classList.add("mainDiv","spritesheet"),document.body.append(c.mainDiv),this.staticAnimations=this.createStaticAnimations(),this.createVirusCounter(),this.handleKeys()}handleKeys(){document.addEventListener("keydown",e=>{switch(e.code){case"KeyD":this.canMove(this.elementInControl,a.right())&&this.move(this.elementInControl,a.right());break;case"KeyA":this.canMove(this.elementInControl,a.left())&&this.move(this.elementInControl,a.left());break;case"KeyS":this.canMove(this.elementInControl,a.down())&&this.move(this.elementInControl,a.down());break;case"KeyW":this.rotate(this.elementInControl);break;case"KeyP":clearInterval(this.loop);break}})}createRow(e,t){const s=new Array(e),o=document.createElement("tr");for(let i=0;i<e;i++){s[i]=0;const n=document.createElement("td");n.classList.add("cell"),n.id=`${i}_${t}`,o.append(n)}return[s,o]}createBoard(e,t){const s=new Array(t),o=document.createElement("table");for(let i=0;i<t;i++){const[n,l]=this.createRow(e,i);s[i]=n,o.append(l)}return[s,o]}createScoreCounter(){const e=document.createElement("div");this.recordCounter=parseInt(window.localStorage.getItem("record")??"0"),this.scoreCounter=0;const t=document.createElement("div");t.id="recordImgs";const s=document.createElement("div");s.id="scoreImgs",this.updateScoreDiv(t,this.recordCounter),this.updateScoreDiv(s,this.scoreCounter),e.append(t),e.append(s),c.mainDiv.append(e)}addZerosToScore(e,t=7){return(Array(t-e.length).fill(0).join("")??"")+e}convertToImages(e){const t=[];for(let s=0;s<e.length;s++){const o=document.createElement("div");o.style.backgroundPositionX=`${-1155-parseInt(e[s])*24}px`,o.classList.add("spritesheet","letter"),t.push(o)}return t}updateScoreDiv(e,t){e.innerHTML="",this.convertToImages(this.addZerosToScore(t.toString())).forEach(s=>{e.append(s)})}createVirusCounter(){const e=document.createElement("div");e.id="virusCounter",this.convertToImages(this.addZerosToScore(this.virusCount.toString(),2)).forEach(t=>e.append(t)),c.mainDiv.append(e)}updateVirusCounter(){this.virusCount--;const e=document.getElementById("virusCounter");e!==null&&(e.innerHTML="",this.convertToImages(this.addZerosToScore(this.virusCount.toString(),2)).forEach(t=>e.append(t)))}createStaticAnimations(){return[{size:new a(96,73),offset:0,framesInTotal:2,nextFrameOffset:96,positions:[new a(30,220),new a(70,295),new a(120,230)]},{size:new a(96,73),offset:384,framesInTotal:2,nextFrameOffset:96,positions:[new a(120,230),new a(30,220),new a(70,295)]},{size:new a(96,73),offset:768,framesInTotal:2,nextFrameOffset:96,positions:[new a(70,295),new a(120,230),new a(30,220)]}].map(t=>new m(c.mainDiv,t.size,t.offset,t.framesInTotal,t.positions,t.nextFrameOffset))}randomColor(){const e=Math.round(Math.random()*1e3)%3;return e>=0&&e<this.colors.length?this.colors[e]:"violet"}spawnNewBlock(){const e=[{position:new a(Math.floor(c.boardWidth/2)-1,0),color:this.randomColor()},{position:new a(Math.floor(c.boardWidth/2),0),color:this.randomColor()}];for(const s of e)if(this.isCellOccupied(s.position,0)){console.log(s.position),this.gameOver();return}const t={id:this.nextId,segments:e,angle:h.DEG0,active:!0};this.elementInControl=t,this.blocks.set(this.nextId++,t);for(let s=0;s<t.segments.length;s++)this.updateBoard(0,t.id,t.segments[s].position.x,t.segments[s].position.y,t.segments[s].color)}isCellOccupied(e,t){return this.board[e.y][e.x]!==0&&this.board[e.y][e.x]!==t}canMove(e,t){for(const s of e.segments){const o=a.addVec(s.position,t);if(o.y>=c.boardHeight||o.x<0||o.x>=c.boardWidth||this.isCellOccupied(o,e.id))return!1}return!0}move(e,t){for(let s=0;s<e.segments.length;s++)this.updateBoard(1,e.id,e.segments[s].position.x,e.segments[s].position.y,e.segments[s].color);for(let s=0;s<e.segments.length;s++)e.segments[s].position.addVec(t),this.updateBoard(0,e.id,e.segments[s].position.x,e.segments[s].position.y,e.segments[s].color)}rotate(e){for(let t=0;t<e.segments.length;t++)this.updateBoard(1,e.id,e.segments[t].position.x,e.segments[t].position.y,e.segments[t].color);switch(e.angle){case h.DEG0:e.angle+=1,e.segments[0].position.add(0,-1),e.segments[1].position.add(-1,0);break;case h.DEG90:if(e.angle+=1,e.segments[0].position.add(1,1),e.segments[0].position.outOfBoard(c.boardWidth)||this.isCellOccupied(e.segments[0].position,e.id)){const t=a.left();if(this.canMove(e,t))for(let s=0;s<e.segments.length;s++)e.segments[s].position.addVec(t);else e.segments[0].position.subtract(1,1)}break;case h.DEG180:e.angle+=1,e.segments[0].position.add(-1,0),e.segments[1].position.add(0,-1);break;case h.DEG270:if(e.angle=h.DEG0,e.segments[1].position.add(1,1),e.segments[1].position.outOfBoard(c.boardWidth)||this.isCellOccupied(e.segments[1].position,e.id)){const t=a.left();if(this.canMove(e,t))for(let s=0;s<e.segments.length;s++)e.segments[s].position.addVec(t);else e.segments[1].position.subtract(1,1)}break;default:console.error("Unknow rotation value")}for(let t=0;t<e.segments.length;t++)this.updateBoard(0,e.id,e.segments[t].position.x,e.segments[t].position.y,e.segments[t].color)}updateBoard(e,t,s,o,i="",n=""){switch(e){case 0:this.board[o][s]=t,this.boardHTML.rows[o].cells[s].style.backgroundColor=i,this.boardHTML.rows[o].cells[s].classList.add("spritesheet"),t>0?this.boardHTML.rows[o].cells[s].classList.add(`${i}-${n}`):this.boardHTML.rows[o].cells[s].classList.add(`virus-${i}`);break;case 1:this.board[o][s]=0,this.boardHTML.rows[o].cells[s].style.backgroundColor="",this.boardHTML.rows[o].cells[s].className="cell",this.boardHTML.rows[o].cells[s].innerText="";break;default:console.error("Unknown update operation")}}eliminateToSmall(e){for(let t=0;t<e.length;t++)e[t].length<4&&(e[t].length=0)}resetForNextCheck(e,t){return e[t].length>=4?(e.push([]),t++):e[t].length=0,t}checkRow(e){const t=[];t.push([]);let s=0;for(let o=0;o<c.boardWidth;o++)if(this.board[e][o]>0){const i=this.blocks.get(this.board[e][o]);if(typeof i>"u")continue;const n=i.segments[0].position.x===o&&i.segments[0].position.y===e?0:1;t[s].length>0&&t[s][0][0].color!==i.segments[n].color&&(s=this.resetForNextCheck(t,s)),t[s].push([i.segments[n],i.id])}else s=this.resetForNextCheck(t,s);return this.eliminateToSmall(t),t}checkColumn(e){const t=[];t.push([]);let s=0;for(let o=0;o<c.boardHeight;o++){const i=this.board[o][e];if(i>0){const n=this.blocks.get(i);if(typeof n>"u")continue;const l=n.segments[0].position.x===e&&n.segments[0].position.y===o?0:1;t[s].length>0&&t[s][0][0].color!==n.segments[l].color&&(s=this.resetForNextCheck(t,s)),t[s].push([n.segments[l],n.id])}else if(i<0){const n=this.viruses.get(i);if(typeof n>"u")continue;t[s].length>0&&t[s][0][0].color!==n.color&&(s=this.resetForNextCheck(t,s)),t[s].push([n,i])}else s=this.resetForNextCheck(t,s)}return this.eliminateToSmall(t),t}tryToDestroy(e){const t=new Map;for(const s of e.segments){for(const o of this.checkRow(s.position.y))for(const[i,n]of o)t.set(i,n);for(const o of this.checkColumn(s.position.x))for(const[i,n]of o)t.set(i,n)}return t.forEach((s,o)=>{const i=this.blocks.get(s);if(typeof i<"u"){const n=i.segments[0].position.x===o.position.x&&i.segments[0].position.y===o.position.y?0:1;this.updateBoard(1,i.id,i.segments[n].position.x,i.segments[n].position.y,i.segments[n].color),i.segments.splice(n,1)}else{const n=this.viruses.get(s);typeof n<"u"&&(this.updateBoard(1,s,n.position.x,n.position.y),this.setScore(100),this.viruses.delete(s))}}),t.size>3}setScore(e){this.scoreCounter+=e;const t=document.getElementById("scoreImgs");if(this.updateScoreDiv(t,this.scoreCounter),this.updateVirusCounter(),this.recordCounter<this.scoreCounter){const s=document.getElementById("recordImgs");s!==null&&(this.recordCounter=this.scoreCounter,this.updateScoreDiv(s,this.recordCounter)),window.localStorage.setItem("record",this.recordCounter.toString())}}findFreeSpace(){const e=Math.floor(Math.random()*(c.boardHeight-8))+5,t=Math.floor(Math.random()*(c.boardWidth-1));for(let s=e;s>=0;s--)for(let o=t;o>=0;o--)if(this.board[s][o]===0){let i=!0;for(let n=-1;n<2&&i;n++)for(let l=-1;l<2&&i;l++)s+n<0||s+n>=c.boardHeight||o+l<0||o+l>=c.boardWidth||this.board[s+n][o+l]!==0&&(i=!1);if(i)return[o,s]}return[-1,-1]}spawnVirus(e,t,s,o){const i=(s+1)*-1,n={position:new a(e,t),color:o};this.updateBoard(0,i,e,t,o),this.viruses.set(i,n)}generateViruses(){console.log(this.virusCount);for(let e=0;e<this.virusCount;e++){const[t,s]=this.findFreeSpace(),o=this.randomColor();t>-1&&s>-1&&this.spawnVirus(t,s,e,o)}}gameOver(){console.log("game over"),clearInterval(this.loop);const e=document.createElement("dialog");e.classList.add("spritesheet"),e.classList.add("dialog"),c.mainDiv.appendChild(e),e.open=!0}debugPrintBoard(){for(let e=0;e<c.boardHeight;e++){let t="";for(let s=0;s<c.boardWidth;s++)t+="|"+this.board[e][s].toString();console.log(t)}}mainLoop(){this.loop!==-1&&clearInterval(this.loop),this.elementInControl.id===-1&&this.spawnNewBlock(),this.generateViruses(),this.debugPrintBoard(),this.loop=setInterval(()=>{let e=!1;this.staticAnimations.forEach(s=>s.update());const t=this.blocks.keys();for(const s of t){const o=this.blocks.get(s);if(!(typeof o>"u")){if(o.segments.length===0){this.blocks.delete(s);continue}if(o.active)if(this.canMove(o,a.down()))(o.id!==this.elementInControl.id||this.frame===0)&&this.move(o,a.down());else{if(this.tryToDestroy(o))for(const[i,n]of this.blocks)n.active=!0;else o.active=!1;o.id===this.elementInControl.id&&!e&&(this.spawnNewBlock(),e=!0)}else o.id===this.elementInControl.id&&!e&&(this.spawnNewBlock(),e=!0)}}this.frame=(this.frame+1)%5},100)}};let u=c;r(u,"mainDiv",document.createElement("div")),r(u,"boardWidth",8),r(u,"boardHeight",16);const g=new u;g.mainLoop();
